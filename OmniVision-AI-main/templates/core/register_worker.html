{% extends 'core/base_dashboard.html' %}

{% block title %}Register New Worker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Worker Registration Form</h5>
            </div>
            <div class="card-body">
                <form id="workerForm" method="post">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="employee_id" class="form-label">Employee ID</label>
                            <input type="text" class="form-control" id="employee_id" name="employee_id" required>
                        </div>
                        <div class="col-12">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="emergency_contact" class="form-label">Emergency Contact</label>
                            <input type="text" class="form-control" id="emergency_contact" name="emergency_contact">
                        </div>
                    </div>
                    
                    <!-- Hidden inputs for face data -->
                    <input type="hidden" id="face_left" name="face_left">
                    <input type="hidden" id="face_right" name="face_right">
                    <input type="hidden" id="face_center" name="face_center">
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="fas fa-save me-2"></i>Register Worker
                        </button>
                        <a href="/api/core/ui/attendance/" class="btn btn-secondary ms-2">
                            <i class="fas fa-arrow-left me-2"></i>Back to Attendance
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Liveness Detection</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <video id="video" width="100%" height="200" autoplay muted style="border-radius: 8px; background: #000;"></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                </div>
                
                <div class="liveness-steps">
                    <div class="step" id="step-center">
                        <div class="step-indicator">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="step-content">
                            <h6>Look at Camera</h6>
                            <p>Position your face in the center</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="captureFace('center')">Capture</button>
                        </div>
                    </div>
                    
                    <div class="step" id="step-left">
                        <div class="step-indicator">
                            <i class="fas fa-arrow-left"></i>
                        </div>
                        <div class="step-content">
                            <h6>Turn Left</h6>
                            <p>Turn your head to the left</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="captureFace('left')">Capture</button>
                        </div>
                    </div>
                    
                    <div class="step" id="step-right">
                        <div class="step-indicator">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="step-content">
                            <h6>Turn Right</h6>
                            <p>Turn your head to the right</p>
                            <button class="btn btn-sm btn-outline-primary" onclick="captureFace('right')">Capture</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted">Complete all steps to enable registration</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registration Successful</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Worker has been registered successfully!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let video, canvas, ctx;
let capturedFaces = { center: false, left: false, right: false };

// Initialize camera
async function initCamera() {
    try {
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        ctx = canvas.getContext('2d');
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: 640, 
                height: 480,
                facingMode: 'user'
            } 
        });
        video.srcObject = stream;
        
        // Update step indicators
        updateStepIndicators();
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Camera access denied. Please allow camera access to continue.');
    }
}

// Capture face for specific direction
function captureFace(direction) {
    if (!video || !canvas) return;
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    // Convert to base64
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Store the image data
    document.getElementById(`face_${direction}`).value = imageData;
    capturedFaces[direction] = true;
    
    // Update UI
    updateStepIndicators();
    updateProgress();
    checkFormReady();
    
    // Show success feedback
    const stepElement = document.getElementById(`step-${direction}`);
    stepElement.classList.add('completed');
    
    // Disable the capture button
    const button = stepElement.querySelector('button');
    button.disabled = true;
    button.textContent = 'Captured âœ“';
    button.classList.remove('btn-outline-primary');
    button.classList.add('btn-success');
}

// Update step indicators
function updateStepIndicators() {
    Object.keys(capturedFaces).forEach(direction => {
        const stepElement = document.getElementById(`step-${direction}`);
        if (capturedFaces[direction]) {
            stepElement.classList.add('completed');
        } else {
            stepElement.classList.remove('completed');
        }
    });
}

// Update progress bar
function updateProgress() {
    const completed = Object.values(capturedFaces).filter(Boolean).length;
    const total = Object.keys(capturedFaces).length;
    const percentage = (completed / total) * 100;
    
    document.getElementById('progressBar').style.width = percentage + '%';
}

// Check if form is ready for submission
function checkFormReady() {
    const allCaptured = Object.values(capturedFaces).every(Boolean);
    const formValid = document.getElementById('name').value && document.getElementById('employee_id').value;
    
    document.getElementById('submitBtn').disabled = !(allCaptured && formValid);
}

// Form submission
document.getElementById('workerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registering...';
    
    try {
        const formData = new FormData(this);
        const response = await fetch('/api/core/ui/register-worker/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Show success modal
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
            
            // Reset form
            this.reset();
            Object.keys(capturedFaces).forEach(key => capturedFaces[key] = false);
            updateStepIndicators();
            updateProgress();
            
            // Re-enable capture buttons
            document.querySelectorAll('.step button').forEach(btn => {
                btn.disabled = false;
                btn.textContent = 'Capture';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-primary');
            });
            
        } else {
            alert('Error: ' + result.message);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while registering the worker.');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Register Worker';
    }
});

// Form validation
document.getElementById('name').addEventListener('input', checkFormReady);
document.getElementById('employee_id').addEventListener('input', checkFormReady);

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initCamera();
});
</script>

<style>
.liveness-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.step {
    display: flex;
    align-items: center;
    padding: 1rem;
    border: 2px solid #444;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.step.completed {
    border-color: #00ff00;
    background: rgba(0, 255, 0, 0.1);
}

.step-indicator {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #444;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    color: #fff;
    font-size: 1.2rem;
}

.step.completed .step-indicator {
    background: #00ff00;
    color: #000;
}

.step-content {
    flex: 1;
}

.step-content h6 {
    margin: 0 0 0.25rem 0;
    color: #fff;
}

.step-content p {
    margin: 0;
    color: #ccc;
    font-size: 0.9rem;
}

.progress {
    height: 8px;
    background: #333;
    border-radius: 4px;
}

.progress-bar {
    background: linear-gradient(45deg, #00ff00, #00ffff);
    transition: width 0.3s ease;
}

.form-control {
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid #444;
    color: #fff;
}

.form-control:focus {
    background: rgba(0, 0, 0, 0.8);
    border-color: #00ffff;
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    color: #fff;
}

.form-label {
    color: #fff;
    font-weight: 600;
}

.btn-primary {
    background: linear-gradient(45deg, #00ffff, #0080ff);
    border: none;
    color: #000;
    font-weight: 600;
}

.btn-primary:hover {
    background: linear-gradient(45deg, #00cccc, #0066cc);
    transform: translateY(-2px);
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid #666;
    color: #fff;
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
}

.btn-outline-primary {
    border: 1px solid #00ffff;
    color: #00ffff;
    background: transparent;
}

.btn-outline-primary:hover {
    background: #00ffff;
    color: #000;
}

.btn-success {
    background: #00ff00;
    color: #000;
    border: none;
}
</style>
{% endblock %}
